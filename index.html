<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Input XML Coretax - Optimized</title>
    <style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }
    .container {
        background: #fff;
        max-width: 900px;
        margin: 0 auto;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h2, h3 {
        color: #2c3e50;
        margin-bottom: 20px;
    }
    h2 {
        text-align: center;
        border-bottom: 3px solid #3498db;
        padding-bottom: 15px;
    }
    label {
        display: block;
        margin-top: 15px;
        font-weight: 600;
        color: #34495e;
    }
    input, textarea, select {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        margin-bottom: 10px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #3498db;
    }
    button {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px 5px 5px 0;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    button:hover {
        background: linear-gradient(135deg, #2980b9, #2471a3);
        transform: translateY(-1px);
    }
    button:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
    }
    button.danger {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    button.danger:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
    }
    button.secondary {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    }
    button.secondary:hover {
        background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
    }
    #xmlOutput {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }
    .good-service {
        border: 2px solid #e1e8ed;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        background: #f8f9fa;
        position: relative;
    }
    .good-service h4 {
        margin-top: 0;
        color: #2980b9;
    }
    .nav {
        margin-bottom: 30px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }
    .nav button {
        background: #ecf0f1;
        color: #34495e;
        min-width: 120px;
    }
    .nav .active {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
    }
    .nav .completed {
        background: linear-gradient(135deg, #27ae60, #219a52);
        color: white;
    }
    .error {
        color: #e74c3c;
        background: #fdf2f2;
        padding: 10px;
        border-radius: 6px;
        border-left: 4px solid #e74c3c;
        margin-bottom: 20px;
        font-weight: 500;
    }
    .success {
        color: #27ae60;
        background: #f0f9f4;
        padding: 10px;
        border-radius: 6px;
        border-left: 4px solid #27ae60;
        margin-bottom: 20px;
        font-weight: 500;
    }
    .invoice-item {
        background: #fff;
        border: 2px solid #e1e8ed;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .invoice-info {
        flex-grow: 1;
    }
    .invoice-actions {
        display: flex;
        gap: 5px;
    }
    .form-row {
        display: flex;
        gap: 15px;
    }
    .form-row > div {
        flex: 1;
    }
    .progress-bar {
        height: 4px;
        background: #e1e8ed;
        border-radius: 2px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2980b9);
        transition: width 0.3s ease;
    }
    .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .stat-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        flex: 1;
        text-align: center;
        min-width: 120px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2980b9;
    }
    .stat-label {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }
    @media (max-width: 768px) {
        .container {
            margin: 0;
            border-radius: 0;
            padding: 20px;
        }
        .form-row {
            flex-direction: column;
        }
        .nav {
            flex-direction: column;
        }
        .invoice-item {
            flex-direction: column;
            align-items: stretch;
        }
        .invoice-actions {
            margin-top: 10px;
            justify-content: flex-end;
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <h2>Form Input XML Coretax</h2>
        <div id="app"></div>
    </div>
    <script>
    class CoretaxApp {
        constructor() {
            this.app = document.getElementById('app');
            this.state = {
                step: 0,
                invoices: [],
                currentInvoice: 0,
                error: '',
                success: ''
            };
            this.navTitles = ['Daftar Faktur', 'Detail Faktur', 'Barang/Jasa', 'Preview & Export'];
            this.init();
        }

        init() {
            this.render();
        }

        setState(newState) {
            this.state = { ...this.state, ...newState };
            this.render();
        }

        clearMessages() {
            this.setState({ error: '', success: '' });
        }

        showError(message) {
            this.setState({ error: message, success: '' });
        }

        showSuccess(message) {
            this.setState({ success: message, error: '' });
        }

        getProgress() {
            return ((this.state.step + 1) / this.navTitles.length) * 100;
        }

        getCompletedSteps() {
            const invoice = this.state.invoices[this.state.currentInvoice];
            if (!invoice) return [];
            
            const completed = [];
            if (invoice.taxData && Object.keys(invoice.taxData).length > 0) completed.push(1);
            if (invoice.goodServices && invoice.goodServices.length > 0) completed.push(2);
            return completed;
        }

        renderNav() {
            const completedSteps = this.getCompletedSteps();
            return `
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${this.getProgress()}%"></div>
                </div>
                <div class="nav">
                    ${this.navTitles.map((title, i) => {
                        let className = '';
                        if (this.state.step === i) className = 'active';
                        else if (completedSteps.includes(i)) className = 'completed';
                        
                        return `<button class='${className}' onclick='app.goStep(${i})' ${i > 0 && this.state.invoices.length === 0 ? 'disabled' : ''}>${title}</button>`;
                    }).join('')}
                </div>
            `;
        }

        renderMessages() {
            let html = '';
            if (this.state.error) {
                html += `<div class='error'>${this.state.error}</div>`;
            }
            if (this.state.success) {
                html += `<div class='success'>${this.state.success}</div>`;
            }
            return html;
        }

        renderStats() {
            const totalInvoices = this.state.invoices.length;
            const totalItems = this.state.invoices.reduce((sum, inv) => 
                sum + (inv.goodServices ? inv.goodServices.length : 0), 0);
            
            return `
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value">${totalInvoices}</div>
                        <div class="stat-label">Total Faktur</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${totalItems}</div>
                        <div class="stat-label">Total Item</div>
                    </div>
                </div>
            `;
        }

        renderStep0() {
            return `
                <h3>Daftar Faktur Pajak</h3>
                ${this.state.invoices.length > 0 ? this.renderStats() : ''}
                <button type='button' onclick='app.addInvoice()'>+ Tambah Faktur Baru</button>
                
                ${this.state.invoices.length === 0 ? 
                    '<p style="text-align: center; color: #7f8c8d; margin: 40px 0;">Belum ada faktur. Klik tombol di atas untuk menambah faktur pertama.</p>' :
                    `<div style="margin-top: 20px;">
                        ${this.state.invoices.map((inv, i) => `
                            <div class="invoice-item">
                                <div class="invoice-info">
                                    <strong>Faktur #${i+1}</strong><br>
                                    <small>Buyer: ${inv.taxData?.BuyerName || '(belum diisi)'}</small><br>
                                    <small>Status: ${this.getInvoiceStatus(inv)}</small>
                                </div>
                                <div class="invoice-actions">
                                    <button onclick='app.editInvoice(${i})'>Edit</button>
                                    <button class="danger" onclick='app.removeInvoice(${i})'>Hapus</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${this.state.invoices.length > 0 ? 
                        `<div style="margin-top: 20px; text-align: center;">
                            <button onclick='app.goStep(3)' style="font-size: 16px; padding: 15px 30px;">üìÑ Preview & Export XML</button>
                        </div>` : ''
                    }`
                }
            `;
        }

        getInvoiceStatus(invoice) {
            if (!invoice.taxData || Object.keys(invoice.taxData).length === 0) {
                return '‚ùå Belum lengkap';
            }
            if (!invoice.goodServices || invoice.goodServices.length === 0) {
                return '‚ö†Ô∏è Perlu barang/jasa';
            }
            return '‚úÖ Lengkap';
        }

        renderStep1() {
            const invoice = this.state.invoices[this.state.currentInvoice] || {taxData:{}};
            const data = invoice.taxData || {};
            
            return `
                <h3>Detail Faktur #${this.state.currentInvoice + 1}</h3>
                <form id='taxForm'>
                    <div class="form-row">
                        <div>
                            <label>TIN <span style="color: red;">*</span></label>
                            <input type='text' name='TIN' value='${data.TIN || ''}' required 
                                   placeholder="Contoh: 123456789012345">
                        </div>
                        <div>
                            <label>Tanggal Faktur <span style="color: red;">*</span></label>
                            <input type='date' name='TaxInvoiceDate' value='${data.TaxInvoiceDate || ''}' required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div>
                            <label>Opsi Faktur <span style="color: red;">*</span></label>
                            <select name='TaxInvoiceOpt' required>
                                <option value="">Pilih Opsi</option>
                                <option value="01" ${data.TaxInvoiceOpt === '01' ? 'selected' : ''}>01 - Faktur Pajak Normal</option>
                                <option value="02" ${data.TaxInvoiceOpt === '02' ? 'selected' : ''}>02 - Faktur Pajak Pengganti</option>
                                <option value="03" ${data.TaxInvoiceOpt === '03' ? 'selected' : ''}>03 - Faktur Pajak Pembatalan</option>
                            </select>
                        </div>
                        <div>
                            <label>Kode Transaksi <span style="color: red;">*</span></label>
                            <select name='TrxCode' required>
                                <option value="">Pilih Kode</option>
                                <option value="01" ${data.TrxCode === '01' ? 'selected' : ''}>01 - Kepada Pihak yang Bukan Pemungut PPN</option>
                                <option value="02" ${data.TrxCode === '02' ? 'selected' : ''}>02 - Kepada Pemungut Bendaharawan</option>
                                <option value="03" ${data.TrxCode === '03' ? 'selected' : ''}>03 - Kepada Pemungut Selain Bendaharawan</option>
                            </select>
                        </div>
                    </div>
                    
                    <label>Seller IDTKU <span style="color: red;">*</span></label>
                    <input type='text' name='SellerIDTKU' value='${data.SellerIDTKU || ''}' required 
                           placeholder="ID Pengusaha Kena Pajak Penjual">
                    
                    <div class="form-row">
                        <div>
                            <label>Buyer TIN <span style="color: red;">*</span></label>
                            <input type='text' name='BuyerTin' value='${data.BuyerTin || ''}' required 
                                   placeholder="NPWP Pembeli">
                        </div>
                        <div>
                            <label>Buyer Name <span style="color: red;">*</span></label>
                            <input type='text' name='BuyerName' value='${data.BuyerName || ''}' required 
                                   placeholder="Nama Pembeli">
                        </div>
                    </div>
                    
                    <label>Alamat Pembeli <span style="color: red;">*</span></label>
                    <textarea name='BuyerAdress' rows="3" required placeholder="Alamat lengkap pembeli">${data.BuyerAdress || ''}</textarea>
                    
                    <label>Email Pembeli</label>
                    <input type='email' name='BuyerEmail' value='${data.BuyerEmail || ''}' 
                           placeholder="email@pembeli.com">
                    
                    <div style="margin-top: 20px;">
                        <button type='submit'>üíæ Simpan & Lanjut ke Barang/Jasa</button>
                        <button type='button' class="secondary" onclick='app.goStep(0)'>‚Üê Kembali ke Daftar</button>
                    </div>
                </form>
            `;
        }

        renderStep2() {
            const invoice = this.state.invoices[this.state.currentInvoice];
            if (!invoice.goodServices) invoice.goodServices = [];
            
            return `
                <h3>Barang/Jasa - Faktur #${this.state.currentInvoice + 1}</h3>
                <form id='goodsForm'>
                    <div id='goodsContainer'>
                        ${invoice.goodServices.length === 0 ? 
                            '<p style="text-align: center; color: #7f8c8d; margin: 40px 0;">Belum ada barang/jasa. Klik tombol di bawah untuk menambah.</p>' :
                            invoice.goodServices.map((g, i) => this.renderGoodServiceForm(i, g)).join('')
                        }
                    </div>
                    
                    <button type='button' onclick='app.addGoodService()' class="secondary">+ Tambah Barang/Jasa</button>
                    
                    <div style="margin-top: 20px; border-top: 1px solid #e1e8ed; padding-top: 20px;">
                        <button type='submit' ${invoice.goodServices.length === 0 ? 'disabled' : ''}>
                            üíæ Simpan Barang/Jasa
                        </button>
                        <button type='button' class="secondary" onclick='app.goStep(1)'>‚Üê Kembali ke Detail Faktur</button>
                    </div>
                </form>
            `;
        }

        renderGoodServiceForm(index, good) {
            const g = good || {};
            return `
                <div class='good-service'>
                    <h4>Barang/Jasa #${index + 1}</h4>
                    
                    <div class="form-row">
                        <div>
                            <label>Opsi <span style="color: red;">*</span></label>
                            <select name='Opt${index}' required>
                                <option value="">Pilih</option>
                                <option value="Y" ${g.Opt === 'Y' ? 'selected' : ''}>Y - Ya</option>
                                <option value="T" ${g.Opt === 'T' ? 'selected' : ''}>T - Tidak</option>
                            </select>
                        </div>
                        <div>
                            <label>Kode <span style="color: red;">*</span></label>
                            <input type='text' name='Code${index}' value='${g.Code || ''}' required 
                                   placeholder="Kode barang/jasa">
                        </div>
                    </div>
                    
                    <label>Nama Barang/Jasa <span style="color: red;">*</span></label>
                    <input type='text' name='Name${index}' value='${g.Name || ''}' required 
                           placeholder="Nama lengkap barang/jasa">
                    
                    <div class="form-row">
                        <div>
                            <label>Satuan <span style="color: red;">*</span></label>
                            <input type='text' name='Unit${index}' value='${g.Unit || ''}' required 
                                   placeholder="pcs, kg, m, dll">
                        </div>
                        <div>
                            <label>Harga Satuan <span style="color: red;">*</span></label>
                            <input type='number' name='Price${index}' value='${g.Price || ''}' required 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Jumlah <span style="color: red;">*</span></label>
                            <input type='number' name='Qty${index}' value='${g.Qty || ''}' required 
                                   min="0" step="0.01" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div>
                            <label>Total Diskon</label>
                            <input type='number' name='TotalDiscount${index}' value='${g.TotalDiscount || '0'}' 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Dasar Pengenaan Pajak <span style="color: red;">*</span></label>
                            <input type='number' name='TaxBase${index}' value='${g.TaxBase || ''}' required 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div>
                            <label>Dasar Pajak Lainnya</label>
                            <input type='number' name='OtherTaxBase${index}' value='${g.OtherTaxBase || '0'}' 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Tarif PPN (%) <span style="color: red;">*</span></label>
                            <select name='VATRate${index}' required>
                                <option value="">Pilih Tarif</option>
                                <option value="11" ${g.VATRate == '11' ? 'selected' : ''}>11%</option>
                                <option value="12" ${g.VATRate == '12' ? 'selected' : ''}>12%</option>
                            </select>
                        </div>
                        <div>
                            <label>Jumlah PPN <span style="color: red;">*</span></label>
                            <input type='number' name='VAT${index}' value='${g.VAT || ''}' required 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div>
                            <label>Tarif PPnBM (%)</label>
                            <input type='number' name='STLGRate${index}' value='${g.STLGRate || '0'}' 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                        <div>
                            <label>Jumlah PPnBM</label>
                            <input type='number' name='STLG${index}' value='${g.STLG || '0'}' 
                                   min="0" step="0.01" placeholder="0.00">
                        </div>
                    </div>
                    
                    <button type='button' class="danger" onclick='app.removeGoodService(${index})'>
                        üóëÔ∏è Hapus Item Ini
                    </button>
                </div>
            `;
        }

        renderStep3() {
            const xml = this.generateXML();
            return `
                <h3>Preview & Export XML</h3>
                ${this.renderStats()}
                
                <div style="margin-bottom: 20px;">
                    <button onclick='app.exportXML()' style="font-size: 16px; padding: 15px 30px;">
                        üì• Download XML File
                    </button>
                    <button onclick='app.copyXML()' class="secondary">
                        üìã Copy ke Clipboard
                    </button>
                    <button onclick='app.goStep(0)' class="secondary">‚Üê Kembali ke Daftar</button>
                </div>
                
                <h4>Hasil XML:</h4>
                <textarea id='xmlOutput' rows='25' readonly>${xml}</textarea>
            `;
        }

        render() {
            let html = this.renderNav();
            html += this.renderMessages();
            
            switch(this.state.step) {
                case 0: html += this.renderStep0(); break;
                case 1: html += this.renderStep1(); break;
                case 2: html += this.renderStep2(); break;
                case 3: html += this.renderStep3(); break;
            }
            
            this.app.innerHTML = html;
            this.attachEventHandlers();
        }

        attachEventHandlers() {
            // Tax form handler
            const taxForm = document.getElementById('taxForm');
            if (taxForm) {
                taxForm.onsubmit = (e) => this.handleTaxForm(e);
            }
            
            // Goods form handler
            const goodsForm = document.getElementById('goodsForm');
            if (goodsForm) {
                goodsForm.onsubmit = (e) => this.handleGoodsForm(e);
            }
        }

        goStep(step) {
            // Validasi sebelum pindah step
            if (step > 0 && this.state.invoices.length === 0) {
                this.showError('Tambahkan minimal satu faktur terlebih dahulu.');
                return;
            }
            
            this.setState({ step, error: '', success: '' });
        }

        addInvoice() {
            const newInvoice = {
                taxData: {},
                goodServices: []
            };
            
            this.state.invoices.push(newInvoice);
            this.setState({
                currentInvoice: this.state.invoices.length - 1,
                step: 1,
                success: 'Faktur baru ditambahkan. Silakan lengkapi detail faktur.'
            });
        }

        editInvoice(index) {
            this.setState({
                currentInvoice: index,
                step: 1
            });
        }

        removeInvoice(index) {
            if (confirm('Apakah Anda yakin ingin menghapus faktur ini?')) {
                this.state.invoices.splice(index, 1);
                
                if (this.state.currentInvoice >= this.state.invoices.length) {
                    this.state.currentInvoice = Math.max(0, this.state.invoices.length - 1);
                }
                
                this.setState({
                    success: 'Faktur berhasil dihapus.',
                    step: this.state.invoices.length === 0 ? 0 : this.state.step
                });
            }
        }

        addGoodService() {
            const invoice = this.state.invoices[this.state.currentInvoice];
            if (!invoice.goodServices) invoice.goodServices = [];
            
            invoice.goodServices.push({});
            this.render();
        }

        removeGoodService(index) {
            if (confirm('Hapus item barang/jasa ini?')) {
                const invoice = this.state.invoices[this.state.currentInvoice];
                invoice.goodServices.splice(index, 1);
                this.render();
            }
        }

        validateRequired(form, fields) {
            for (const field of fields) {
                const element = form[field];
                if (!element || !element.value.trim()) {
                    return `Field "${field}" wajib diisi.`;
                }
            }
            return null;
        }

        validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return email === '' || emailRegex.test(email);
        }

        handleTaxForm(e) {
            e.preventDefault();
            
            const requiredFields = ['TIN', 'TaxInvoiceDate', 'TaxInvoiceOpt', 'TrxCode', 
                                  'SellerIDTKU', 'BuyerTin', 'BuyerName', 'BuyerAdress'];
            
            const error = this.validateRequired(e.target, requiredFields);
            if (error) {
                this.showError(error);
                return;
            }

            // Validate email if provided
            const email = e.target.BuyerEmail.value;
            if (email && !this.validateEmail(email)) {
                this.showError('Format email tidak valid.');
                return;
            }

            // Validate TIN format (should be 15 digits)
            const tin = e.target.TIN.value;
            if (!/^\d{15}$/.test(tin)) {
                this.showError('TIN harus terdiri dari 15 digit angka.');
                return;
            }

            // Save data to current invoice
            const invoice = this.state.invoices[this.state.currentInvoice];
            invoice.taxData = {
                TIN: e.target.TIN.value.trim(),
                TaxInvoiceDate: e.target.TaxInvoiceDate.value,
                TaxInvoiceOpt: e.target.TaxInvoiceOpt.value,
                TrxCode: e.target.TrxCode.value,
                SellerIDTKU: e.target.SellerIDTKU.value.trim(),
                BuyerTin: e.target.BuyerTin.value.trim(),
                BuyerName: e.target.BuyerName.value.trim(),
                BuyerAdress: e.target.BuyerAdress.value.trim(),
                BuyerEmail: e.target.BuyerEmail.value.trim()
            };

            this.setState({
                step: 2,
                success: 'Detail faktur berhasil disimpan. Silakan tambahkan barang/jasa.'
            });
        }

        handleGoodsForm(e) {
            e.preventDefault();
            
            const invoice = this.state.invoices[this.state.currentInvoice];
            
            if (!invoice.goodServices || invoice.goodServices.length === 0) {
                this.showError('Minimal 1 barang/jasa harus ditambahkan.');
                return;
            }

            let hasError = false;
            
            // Validate each good/service
            invoice.goodServices.forEach((good, i) => {
                if (hasError) return;
                
                const requiredFields = ['Opt', 'Code', 'Name', 'Unit', 'Price', 'Qty', 'TaxBase', 'VATRate', 'VAT'];
                
                for (const field of requiredFields) {
                    const element = e.target[`${field}${i}`];
                    if (!element || !element.value.toString().trim()) {
                        this.showError(`Field "${field}" pada Barang/Jasa #${i+1} wajib diisi.`);
                        hasError = true;
                        return;
                    }
                }

                // Validate numeric fields
                const numericFields = ['Price', 'Qty', 'TaxBase', 'VAT'];
                for (const field of numericFields) {
                    const value = parseFloat(e.target[`${field}${i}`].value);
                    if (isNaN(value) || value < 0) {
                        this.showError(`Field "${field}" pada Barang/Jasa #${i+1} harus berupa angka positif.`);
                        hasError = true;
                        return;
                    }
                }

                // Update good/service data
                invoice.goodServices[i] = {
                    Opt: e.target[`Opt${i}`].value,
                    Code: e.target[`Code${i}`].value.trim(),
                    Name: e.target[`Name${i}`].value.trim(),
                    Unit: e.target[`Unit${i}`].value.trim(),
                    Price: parseFloat(e.target[`Price${i}`].value),
                    Qty: parseFloat(e.target[`Qty${i}`].value),
                    TotalDiscount: parseFloat(e.target[`TotalDiscount${i}`].value) || 0,
                    TaxBase: parseFloat(e.target[`TaxBase${i}`].value),
                    OtherTaxBase: parseFloat(e.target[`OtherTaxBase${i}`].value) || 0,
                    VATRate: parseFloat(e.target[`VATRate${i}`].value),
                    VAT: parseFloat(e.target[`VAT${i}`].value),
                    STLGRate: parseFloat(e.target[`STLGRate${i}`].value) || 0,
                    STLG: parseFloat(e.target[`STLG${i}`].value) || 0
                };
            });

            if (!hasError) {
                this.setState({
                    step: 0,
                    success: 'Barang/jasa berhasil disimpan. Faktur telah lengkap.'
                });
            }
        }

        generateXML() {
            if (this.state.invoices.length === 0) return '';
            
            let xml = `<?xml version="1.0" encoding="utf-8"?>\n`;
            xml += `<TaxInvoiceBulk xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n`;
            xml += `  <TIN>${this.state.invoices[0].taxData.TIN}</TIN>\n`;
            xml += `  <ListOfTaxInvoice>\n`;
            
            this.state.invoices.forEach(invoice => {
                if (!invoice.taxData || !invoice.goodServices) return;
                
                xml += `    <TaxInvoice>\n`;
                xml += `      <TaxInvoiceDate>${invoice.taxData.TaxInvoiceDate}</TaxInvoiceDate>\n`;
                xml += `      <TaxInvoiceOpt>${invoice.taxData.TaxInvoiceOpt}</TaxInvoiceOpt>\n`;
                xml += `      <TrxCode>${invoice.taxData.TrxCode}</TrxCode>\n`;
                xml += `      <AddInfo></AddInfo>\n`;
                xml += `      <CustomDoc></CustomDoc>\n`;
                xml += `      <RefDesc></RefDesc>\n`;
                xml += `      <FacilityStamp></FacilityStamp>\n`;
                xml += `      <SellerIDTKU>${invoice.taxData.SellerIDTKU}</SellerIDTKU>\n`;
                xml += `      <BuyerTin>${invoice.taxData.BuyerTin}</BuyerTin>\n`;
                xml += `      <BuyerDocument>TIN</BuyerDocument>\n`;
                xml += `      <BuyerCountry>IDN</BuyerCountry>\n`;
                xml += `      <BuyerDocumentNumber>-</BuyerDocumentNumber>\n`;
                xml += `      <BuyerName><![CDATA[${invoice.taxData.BuyerName}]]></BuyerName>\n`;
                xml += `      <BuyerAdress><![CDATA[${invoice.taxData.BuyerAdress}]]></BuyerAdress>\n`;
                xml += `      <BuyerEmail>${invoice.taxData.BuyerEmail}</BuyerEmail>\n`;
                xml += `      <BuyerIDTKU>${invoice.taxData.BuyerTin}000000</BuyerIDTKU>\n`;
                xml += `      <ListOfGoodService>\n`;
                
                invoice.goodServices.forEach(good => {
                    xml += `        <GoodService>\n`;
                    xml += `          <Opt>${good.Opt}</Opt>\n`;
                    xml += `          <Code>${good.Code}</Code>\n`;
                    xml += `          <Name><![CDATA[${good.Name}]]></Name>\n`;
                    xml += `          <Unit>${good.Unit}</Unit>\n`;
                    xml += `          <Price>${good.Price}</Price>\n`;
                    xml += `          <Qty>${good.Qty}</Qty>\n`;
                    xml += `          <TotalDiscount>${good.TotalDiscount}</TotalDiscount>\n`;
                    xml += `          <TaxBase>${good.TaxBase}</TaxBase>\n`;
                    xml += `          <OtherTaxBase>${good.OtherTaxBase}</OtherTaxBase>\n`;
                    xml += `          <VATRate>${good.VATRate}</VATRate>\n`;
                    xml += `          <VAT>${good.VAT}</VAT>\n`;
                    xml += `          <STLGRate>${good.STLGRate}</STLGRate>\n`;
                    xml += `          <STLG>${good.STLG}</STLG>\n`;
                    xml += `        </GoodService>\n`;
                });
                
                xml += `      </ListOfGoodService>\n`;
                xml += `    </TaxInvoice>\n`;
            });
            
            xml += `  </ListOfTaxInvoice>\n`;
            xml += `</TaxInvoiceBulk>`;
            
            return xml;
        }

        exportXML() {
            try {
                const xml = this.generateXML();
                if (!xml) {
                    this.showError('Tidak ada data untuk diekspor.');
                    return;
                }
                
                const blob = new Blob([xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `coretax_${new Date().toISOString().split('T')[0]}.xml`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showSuccess('File XML berhasil didownload.');
            } catch (error) {
                this.showError('Gagal mengekspor XML: ' + error.message);
            }
        }

        async copyXML() {
            try {
                const xml = this.generateXML();
                if (!xml) {
                    this.showError('Tidak ada data untuk disalin.');
                    return;
                }
                
                await navigator.clipboard.writeText(xml);
                this.showSuccess('XML berhasil disalin ke clipboard.');
            } catch (error) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = this.generateXML();
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                this.showSuccess('XML berhasil disalin ke clipboard.');
            }
        }
    }

    // Initialize the app
    const app = new CoretaxApp();
    
    // Make app globally accessible for onclick handlers
    window.app = app;
    </script>
</body>
</html>